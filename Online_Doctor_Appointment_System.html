<!DOCTYPE html>
<html lang="th">
<head>
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    <link rel="stylesheet" type="text/css" href="main.css">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.4/dist/web3.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Mali:wght@300;400;500&display=swap');
    </style>
</head>
<body>
    <div class="container">
        <div class="status" id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

        <div class="nav">
            <button class="nav-btn active" onclick="showPage('doctors', event)">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå</button>
            <button class="nav-btn" onclick="showPage('reservations', event)">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
        </div>

        <!-- Doctors Page -->
        <div id="doctors-page" class="page active">
            <div class="doctor-grid"></div>
        </div>

        <!-- Reservations Page -->
        <div id="reservations-page" class="page">
            <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h2>
            <table class="reservations-table">
                <thead>
                    <tr>
                        <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                        <th>‡πÅ‡∏û‡∏ó‡∏¢‡πå</th>
                        <th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (address)</th>
                    </tr>
                </thead>
                <tbody id="reservationsBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const doctors = [
            { id: 1, name: "‡∏û‡∏ç. ‡∏Æ‡∏±‡∏ô ‡∏à‡∏µ‡∏¢‡∏π", schedule: "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå | 19.00 ‡∏ô. - 19.55 ‡∏ô.", price: "0.0001 Ether", cases: 119, rating: 5.0, image: "./images/d1.png" },
            { id: 2, name: "‡∏ô‡∏û. ‡∏à‡∏≤‡∏á ‡∏≠‡∏π‡∏à‡∏µ", schedule: "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£ | 18.00 ‡∏ô. - 18.55 ‡∏ô.", price: "0.0001 Ether", cases: 96, rating: 4.9, image: "./images/d2.png" },
            { id: 3, name: "‡∏û‡∏ç. ‡∏¢‡∏π ‡∏Æ‡πÄ‡∏¢‡∏à‡∏≠‡∏á", schedule: "‡∏û‡∏∏‡∏ò | 17.00 ‡∏ô. - 17.55 ‡∏ô.", price: "0.0001 Ether", cases: 98, rating: 4.8, image: "./images/d4.png" },
            { id: 4, name: "‡∏û‡∏ç. ‡∏à‡∏≠‡∏ô ‡∏ß‡∏≠‡∏ô‡∏≠‡∏π", schedule: "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ | 18.00 ‡∏ô. - 18.55 ‡∏ô.", price: "0.0001 Ether", cases: 110, rating: 5.0, image: "./images/d3.png" },
            { id: 5, name: "‡∏û‡∏ç. ‡∏ã‡∏≤‡∏Æ‡∏≤‡∏£‡∏≤", schedule: "‡∏®‡∏∏‡∏Å‡∏£‡πå | 19.00 ‡∏ô. - 19.55 ‡∏ô.", price: "0.0001 Ether", cases: 106, rating: 5.0, image: "./images/d5.png" },
            { id: 6, name: "‡∏ô‡∏û. ‡∏Ñ‡∏¥‡∏° ‡∏ã‡∏π‡∏Ñ‡∏¢‡∏≠‡∏ô", schedule: "‡πÄ‡∏™‡∏≤‡∏£‡πå, ‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå | 16.00 ‡∏ô. - 16.55 ‡∏ô.", price: "0.0001 Ether", cases: 89, rating: 4.7, image: "./images/d6.png" }
        ];

        const doctorGrid = document.querySelector('.doctor-grid');
        doctors.forEach(doctor => {
            doctorGrid.innerHTML += `
                <div class="doctor-card">
                    <div class="logo-container">
                        <img src="${doctor.image}" alt="Doctor Avatar" class="doctor-avatar">
                    </div>
                    <div class="doctor-info">
                        <div class="doctor-name">${doctor.name}</div>
                        <div class="schedule">${doctor.schedule}</div>
                        <div class="price">${doctor.price}</div>
                        <div class="stats">
                            <div class="stat-item">üíö <span>‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</span></div>
                            <div class="stat-item">üë• <span>${doctor.cases} ‡πÄ‡∏Ñ‡∏™</span></div>
                            <div class="stat-item">‚≠ê <span>${doctor.rating}</span></div>
                        </div>
                    </div>
                    <button class="reserve-btn" onclick="reserveAppointment(${doctor.id})">‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</button>
                </div>
            `;
        });

        async function loadWeb3() {
            if (window.ethereum) {
                window.web3 = new Web3(window.ethereum);
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    return true;
                } catch (error) {
                    console.error("User denied account access");
                    return false;
                }
            } else {
                updateStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á MetaMask ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô DApp');
                return false;
            }
        }

        let currentAccount = null;

        function showPage(pageId, event) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId + '-page').classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            localStorage.setItem('activePage', pageId);
            if (pageId === 'reservations') {
                loadReservations();
            }
        }

        window.onload = () => {
            const activePage = localStorage.getItem('activePage') || 'doctors';
            showPage(activePage);
        };

        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                updateStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö MetaMask');
            } else if (accounts[0] !== currentAccount) {
                currentAccount = accounts[0];
                updateStatus(`‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß: ${currentAccount.substring(0, 6)}...${currentAccount.substring(38)}`);
                loadReservations();
            }
        }

        const CONTRACT_ADDRESS = '0x03D0C936534d0978428C861ca1CC55e59D2aAe5C';
        const ABI = [
          {
            "inputs": [],
            "stateMutability": "nonpayable",
            "type": "constructor"
          },
          {
            "anonymous": false,
            "inputs": [
              {
                "indexed": true,
                "internalType": "uint256",
                "name": "reservationId",
                "type": "uint256"
              },
              {
                "indexed": true,
                "internalType": "uint256",
                "name": "doctorId",
                "type": "uint256"
              },
              {
                "indexed": true,
                "internalType": "address",
                "name": "patient",
                "type": "address"
              },
              {
                "indexed": false,
                "internalType": "uint256",
                "name": "timeSlot",
                "type": "uint256"
              },
              {
                "indexed": false,
                "internalType": "string",
                "name": "doctorName",
                "type": "string"
              }
            ],
            "name": "ReservationCreated",
            "type": "event"
          },
          {
            "inputs": [
              {
                "internalType": "uint256",
                "name": "doctorId",
                "type": "uint256"
              }
            ],
            "name": "reserveAppointment",
            "outputs": [],
            "stateMutability": "payable",
            "type": "function"
          },
          {
            "inputs": [],
            "name": "withdraw",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
          },
          {
            "inputs": [
              {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
              },
              {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
              }
            ],
            "name": "doctorSchedule",
            "outputs": [
              {
                "internalType": "bool",
                "name": "",
                "type": "bool"
              }
            ],
            "stateMutability": "view",
            "type": "function"
          },
          {
            "inputs": [],
            "name": "getAllReservations",
            "outputs": [
              {
                "internalType": "uint256[]",
                "name": "times",
                "type": "uint256[]"
              },
              {
                "internalType": "string[]",
                "name": "doctors",
                "type": "string[]"
              },
              {
                "internalType": "address[]",
                "name": "patients",
                "type": "address[]"
              }
            ],
            "stateMutability": "view",
            "type": "function"
          },
          {
            "inputs": [],
            "name": "nextReservationId",
            "outputs": [
              {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
              }
            ],
            "stateMutability": "view",
            "type": "function"
          },
          {
            "inputs": [],
            "name": "owner",
            "outputs": [
              {
                "internalType": "address",
                "name": "",
                "type": "address"
              }
            ],
            "stateMutability": "view",
            "type": "function"
          },
          {
            "inputs": [
              {
                "internalType": "address",
                "name": "",
                "type": "address"
              },
              {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
              }
            ],
            "name": "patientReservations",
            "outputs": [
              {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
              }
            ],
            "stateMutability": "view",
            "type": "function"
          },
          {
            "inputs": [
              {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
              }
            ],
            "name": "reservations",
            "outputs": [
              {
                "internalType": "uint256",
                "name": "doctorId",
                "type": "uint256"
              },
              {
                "internalType": "address",
                "name": "patient",
                "type": "address"
              },
              {
                "internalType": "uint256",
                "name": "timeSlot",
                "type": "uint256"
              },
              {
                "internalType": "uint256",
                "name": "price",
                "type": "uint256"
              },
              {
                "internalType": "string",
                "name": "doctorName",
                "type": "string"
              }
            ],
            "stateMutability": "view",
            "type": "function"
          }
        ];
  
        async function reserveAppointment(doctorId) {
            if (!currentAccount) {
                updateStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            try {
                const contract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
                const price = '0.0001';
                const priceInWei = web3.utils.toWei(price, 'ether');
                
                const transaction = await contract.methods.reserveAppointment(doctorId)
                    .send({
                        from: currentAccount,
                        value: priceInWei
                    });

                updateStatus('‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! Transaction: ' + transaction.transactionHash);
                showPage('reservations', null);
            } catch (error) {
                updateStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß: ' + error.message);
            }
        }

        const doctorNameMapping = {
            "Dr. Han Ji-yu": "‡∏û‡∏ç. ‡∏Æ‡∏±‡∏ô ‡∏à‡∏µ‡∏¢‡∏π",
            "Dr. Zhang Wu-ji": "‡∏ô‡∏û. ‡∏à‡∏≤‡∏á ‡∏≠‡∏π‡∏à‡∏µ",
            "Dr. Yu Hye-jung": "‡∏û‡∏ç. ‡∏¢‡∏π ‡∏Æ‡πÄ‡∏¢‡∏à‡∏≠‡∏á",
            "Dr. Jeon Won-woo": "‡∏û‡∏ç. ‡∏à‡∏≠‡∏ô ‡∏ß‡∏≠‡∏ô‡∏≠‡∏π",
            "Dr. Sahara": "‡∏û‡∏ç. ‡∏ã‡∏≤‡∏Æ‡∏≤‡∏£‡∏≤",
            "Dr. Kim Soo-kyun": "‡∏ô‡∏û. ‡∏Ñ‡∏¥‡∏° ‡∏ã‡∏π‡∏Ñ‡∏¢‡∏≠‡∏ô",
            "Unknown Doctor": "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏û‡∏ó‡∏¢‡πå"
        };

        function loadReservations() {
            const contract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
            
            contract.methods.getAllReservations().call()
                .then(result => {
                    const { times, doctors, patients } = result;
                    const reservationsBody = document.getElementById('reservationsBody');
                    
                    let html = '';
                    for(let i = 0; i < times.length; i++) {
                        const date = new Date(times[i] * 1000);
                        const thaiDoctorName = doctorNameMapping[doctors[i]] || doctors[i];
                        html += `
                            <tr>
                                <td>${date.toLocaleTimeString()}</td>
                                <td>${thaiDoctorName}</td>
                                <td>${patients[i]}</td>
                            </tr>
                        `;
                    }
                    
                    reservationsBody.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading reservations:', error);
                });
        }
        function updateStatus(message) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            console.log(message);
        }

        async function init() {
            if (await loadWeb3()) {
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                const accounts = await web3.eth.getAccounts();
                handleAccountsChanged(accounts);
                updateStatus('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!');
            }
        }

        init();
    </script>
</body>
</html>